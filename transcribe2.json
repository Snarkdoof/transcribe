{
  "workflow": {
    "options": {
      "src": {"help": "Source file"},
      "dst": {"help": "Destination file"},
      "dir": {"help": "Project directory, default '.'", "default": "."},
      "w2vdir": {"help": "w2v directory (where w2vtranscriber is found)"},
      "tmpdir": {"help": "Temporary directory", "default": "/tmp/"},
      "baseurl": {"help": "Base URL on the server for the resources", "default": "/sfi/res/radio/"},
      "lang": {"help": "Language ('no' or 'en' for now)", "default": "no"},
      "intro_len": {"help": "Length of the intro (skip voice identification)"}
    },
    "name": "NORCE_Transcribe",
    "description": "Transcribe from Norwegian sound to Norwegian fancy subs",
    "nodes": [
      {
        "module": "cmdline",
        "name": "start",
        "args": {
        },
        "downstreamOf": ["entry"]
      },
      {
        "module": "mod_prep",
        "name": "prepare",
        "frunOnHead": true,
        "downstreamOf": ["start"],
        "workdir": {"option": "dir"},
        "args": {
          "src": {"option": "src"},
          "dst": {"option": "dst"},
          "dir": {"option": "tmpdir", "ftype": "tempdir", "id": "cammalk123"}
        }
      },
      {
        "module": "ffmpeg",
        "name": "extract_audio",
        "downstreamOf": ["prepare"],
        "args": {
          "src": {"output": "prepare.src"},
          "dst": {"output": "prepare.wavfile"}
        }, "cache": {
          "args": ["src", "dst"],
          "files": ["dst"]
        }
      },
      {
        "module": "ffmpeg",
        "name": "extract_audio_mono",
        "downstreamOf": ["prepare"],
        "args": {
          "src": {"output": "prepare.src"},
          "dst": {"output": "prepare.wavfilemono"},
          "mono": true
        }, "cache": {
          "args": ["src", "dst"],
          "files": ["dst"]
        }
      },
      {
        "module": "ffmpeg",
        "name": "audio_encode",
        "downstreamOf": ["prepare"],
        "args": {
          "src": {"output": "prepare.src"},
          "dst": {"output": "prepare.mp3file"}
        }
      },
      {
        "module": "mod_detect_voice",
        "name": "detect_voice",
        "max_parallel": 1,
        "workdir": {"option": "dir"},
        "downstreamOf": ["extract_audio_mono"],
        "args": {
          "src": {"output": "parent.dst"},
          "format": "csv",
          "max_segment_length": 8,
          "max_pause": 0.2,
          "agressive": 3
        }, "cache": {
          "args": ["src"],
          "files": ["dst"]
        }
      },
      {
        "module": "mod_transcribe",
        "name": "transcribe",
        "gpu": true,
        "docker": "transcribe",
        "max_parallel": 1,
        "workdir": {"option": "dir"},
        "downstreamOf": ["detect_voice", "extract_audio"],
        "args": {
          "src": {"output": "extract_audio.dst"},
          "lang": {"option": "lang"},
          "segments": {"output": "parent.dst"}
        }, "cache": {
          "args": ["src", "segments"],
          "files": ["dst"]
        }
      },
      {
        "module": "mod_transformer",
        "name": "DeUnCase",
        "gpu": true,
        "docker": "transcribe",
        "downstreamOf": ["transcribe"],
        "workdir": {"option": "dir"},
        "args": {
          "model": "north/demo-deuncaser-base",
          "tokenizer": "north/demo-deuncaser-base",
          "src": {"output": "parent.dst"},
          "groupOn": 0
        }, "cache": {
          "args": ["src"],
          "files": ["dst"]
        }
      },
      {
        "module": "mod_speaker_identification",
        "name": "identify",
        "gpu": true,
        "docker": "transcribe",
        "max_parallel": 1,
        "workdir": {"option": "dir"},
        "downstreamOf": ["DeUnCase"],
        "args": {
          "src": {"output": "extract_audio.dst"},
          "segments": {"output": "parent.dst"},
          "max_segments_per_person": 4,
          "threshold": 0.85,
          "skip_start_s": {"option": "intro_len"}
        }, "cache": {
          "args": ["src", "segments", "max_segments_per_person"],
          "files": ["dst"]
        }
      },
      {
        "module": "mod_fancysub",
        "name": "fancysub",
        "downstreamOf": ["identify"],
        "workdir": {"option": "dir"},
        "args": {
          "src": {"output": "parent.dst"},
          "dst": {"option": "dst"},
          "baseurl": {"option": "baseurl"},
          "mediaurl": {"output": "prepare.mp3file"}
        }
      },
      {
        "module": "mod_reformat",
        "name": "reformat",
        "runOn": "never",
        "downstreamOf": ["fancysub"],
        "workdir": {"option": "dir"},
        "args": {
          "src": {"output": "parent.dst"},
          "dst": {"output": "parent.dst"}
        }
      }
    ]
  }
}
